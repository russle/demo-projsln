<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELNè‡ªå‹•åŒ–å ±åƒ¹ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --bg-body: #f4f6f9;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-body);
            color: #333;
            padding-bottom: 80px;
        }
        /* Navbar */
        .navbar { background: var(--primary-gradient); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .navbar-brand { font-weight: 700; color: white !important; letter-spacing: 1px;}
        .role-badge { background: rgba(255,255,255,0.15); padding: 5px 15px; border-radius: 4px; color: white; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.3);}

        /* Tabs */
        .nav-tabs .nav-link { border: none; color: #666; font-weight: 500; padding: 12px 25px; background: transparent; }
        .nav-tabs .nav-link.active { color: #1e3c72; border-bottom: 3px solid #1e3c72; background: transparent; font-weight: 700; }
        .nav-tabs { border-bottom: 1px solid #ddd; margin-bottom: 20px; }

        /* Filter Bar */
        .filter-bar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* Cards & Tags */
        .custom-card { border: none; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s ease; height: 100%; border-top: 4px solid transparent; }
        .custom-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        .ticker-tag { background-color: #e3f2fd; color: #0d47a1; padding: 2px 6px; border-radius: 4px; font-family: 'Roboto Mono', monospace; font-size: 0.75rem; margin-right: 3px; border: 1px solid #bbdefb; display: inline-block; margin-bottom: 3px; }

        /* Status Colors */
        .st-inquiry { border-top-color: #6c757d; }  
        .st-quoted { border-top-color: #0dcaf0; }   
        .st-drafting { border-top-color: #6f42c1; } 
        .st-review { border-top-color: #0d6efd; }   
        .st-setup { border-top-color: #ffc107; }    
        .st-sign { border-top-color: #fd7e14; }     
        .st-ready { border-top-color: #dc3545; } 
        .st-completed { border-top-color: #198754; }

        /* Stepper */
        .stepper { display: flex; justify-content: space-between; margin-bottom: 15px; position: relative; font-size: 0.65rem; color: #ccc; }
        .stepper::before { content: ''; position: absolute; top: 7px; left: 0; right: 0; height: 1px; background: #e0e0e0; z-index: 0; }
        .step-item { position: relative; z-index: 1; text-align: center; background: white; padding: 0 2px; min-width: 30px;}
        .step-dot { width: 14px; height: 14px; border-radius: 50%; background: #f0f0f0; margin: 0 auto 4px; border: 2px solid white; box-shadow: 0 0 0 1px #e0e0e0; }
        .step-item.active .step-dot { background: #0d6efd; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); border-color: #0d6efd;}
        .step-item.active { color: #0d6efd; font-weight: 700; }
        .step-item.done .step-dot { background: #198754; box-shadow: none; border-color: #198754;}
        
        /* Quotation Result Box */
        .quote-result-box { background-color: #f8f9fa; border: 1px dashed #ced4da; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 0.85rem; }
        .quote-result-box.active { background-color: #f0fff4; border: 1px solid #198754; }
        .coupon-rate { font-size: 1.2rem; font-weight: 800; color: #198754; font-family: 'Roboto Mono', monospace; }
        
        /* Notional Input Highlight */
        .notional-highlight { background-color: #fff3cd; border: 2px solid #ffc107; padding: 10px; border-radius: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }

        /* Form Styling */
        .form-label { font-size: 0.8rem; color: #666; font-weight: 500; margin-bottom: 4px; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Styles */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #eee; }
        .confirm-table td { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .confirm-table tr:last-child td { border-bottom: none; }
        .confirm-val { text-align: right; font-weight: 600; color: #333; }
        .highlight-amount { font-size: 1.2rem; color: #198754; font-weight: 800; }

        /* â˜…â˜…â˜… Table View Styles â˜…â˜…â˜… */
        .table-view-container { background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); overflow: hidden; }
        .custom-table thead { background-color: #f8f9fa; border-bottom: 2px solid #eee; }
        .custom-table th { font-weight: 600; font-size: 0.85rem; color: #666; padding: 12px; }
        .custom-table td { vertical-align: middle; font-size: 0.9rem; padding: 12px; border-bottom: 1px solid #f1f1f1; }
        .custom-table tr:hover { background-color: #f8f9fa; }
        .status-badge-sm { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; display: inline-block; min-width: 80px; text-align: center; }
        
        .bg-inquiry { background-color: #6c757d; }
        .bg-quoted { background-color: #0dcaf0; color: #000 !important; }
        .bg-drafting { background-color: #6f42c1; }
        .bg-review { background-color: #0d6efd; }
        .bg-setup { background-color: #ffc107; color: #000 !important; }
        .bg-sign { background-color: #fd7e14; }
        .bg-ready { background-color: #dc3545; }
        .bg-completed { background-color: #198754; }
        .bg-rejected { background-color: #dc3545; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-4 sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-robot me-2"></i>ELNè‡ªå‹•åŒ–å ±åƒ¹ç³»çµ±</a>
        <div class="d-flex align-items-center">
            
            <span class="role-badge me-2">ç›®å‰è§’è‰²</span>
            <select id="roleSwitch" class="form-select form-select-sm border-0 me-3" style="width: 150px; cursor: pointer;" onchange="renderCurrentSnapshot()">
                <option value="ADVISOR" selected>ç†å°ˆ (Sales)</option>
                <option value="PM">PM (Product)</option>
                <option value="TRUST">ä¿¡è¨—éƒ¨ (Ops)</option>
            </select>

            <div class="btn-group">
                <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="window.simulateIssuerReply()">
                    <i class="fas fa-bolt me-1"></i>æ¨¡æ“¬ä¸Šæ‰‹å›è¦†
                </button>
                <button class="btn btn-outline-light btn-sm fw-bold shadow-sm ms-2 border-warning text-warning" style="border-width: 1px;" onclick="window.clearAllData()">
                    <i class="fas fa-trash-alt me-1"></i>æ¸…ç©ºè³‡æ–™
                </button>
            </div>

        </div>
    </div>
</nav>

<div class="container">
    
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-pane" type="button" role="tab"><i class="fas fa-edit me-2"></i>æ–°å¢è©¢åƒ¹</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab"><i class="fas fa-search me-2"></i>æ¡ˆä»¶æŸ¥è©¢</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="create-pane" role="tabpanel">
            <div id="advisorOnlyWarning" class="alert alert-secondary text-center" style="display:none;">
                <i class="fas fa-info-circle me-2"></i>ç›®å‰è§’è‰²ç„¡æ³•æ–°å¢æ¡ˆä»¶ï¼Œè«‹åˆ‡æ›è‡³ã€Œç†å°ˆã€è§’è‰²ã€‚
            </div>
            
            <div id="createFormContainer" class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow-sm border-0 rounded-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center py-3">
                            <h6 class="m-0 text-primary fw-bold">å»ºç«‹çµæ§‹å‹å•†å“è©¢åƒ¹å–®</h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.fillDemoData()">å¸¶å…¥ç¯„ä¾‹</button>
                        </div>
                        <div class="card-body p-4">
                            
                            <div id="successMessage" class="alert alert-success fade-in text-center mb-4 shadow-sm" style="display: none; border-left: 5px solid #198754;">
                                <div class="d-flex align-items-center justify-content-center">
                                    <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                                    <div class="text-start">
                                        <h5 class="alert-heading fw-bold mb-1">é€å‡ºæˆåŠŸï¼</h5>
                                        <p class="mb-0 small">è©¢åƒ¹å–®å·²å»ºç«‹ (Quote ID è‡ªå‹•ç”Ÿæˆ)ã€‚è«‹é»æ“Šä¸Šæ–¹é»ƒè‰²æŒ‰éˆ•æ¨¡æ“¬ä¸Šæ‰‹å›è¦†ã€‚</p>
                                    </div>
                                </div>
                            </div>

                            <form id="orderForm">
                                <div class="row g-3 mb-3 pb-3 border-bottom">
                                    <div class="col-md-3"><label class="form-label">Product Type</label><select class="form-select form-select-sm" id="productType"><option value="FCN">FCN</option><option value="ELN">ELN</option></select></div>
                                    <div class="col-md-3"><label class="form-label">Currency</label><select class="form-select form-select-sm" id="currency"><option value="USD">USD</option><option value="AUD">AUD</option><option value="ZAR">ZAR</option></select></div>
                                    <div class="col-md-3"><label class="form-label">Wrapper</label><input type="text" class="form-control form-control-sm" id="wrapper" placeholder="e.g. EMTN"></div>
                                    <div class="col-md-3"><label class="form-label">ç†å°ˆ (å»ºç«‹è€…)</label><input type="text" class="form-control form-control-sm" id="advisorName" required></div>
                                    <div class="col-md-12"><label class="form-label">å®¢æˆ¶å§“å (Client)</label><input type="text" class="form-control form-control-sm" id="clientName" placeholder="ex: é™³ç‰è"></div>
                                </div>
                                
                                <div class="row g-2 mb-3 bg-light p-3 rounded mx-1">
                                    <div class="col-12"><label class="form-label mb-1 text-primary">Underlying(s) + BBG Codes</label></div>
                                    <div class="col-md-2 col-4"><input type="text" class="form-control form-control-sm text-uppercase" id="ticker1" placeholder="Ticker 1"></div>
                                    <div class="col-md-2 col-4"><input type="text" class="form-control form-control-sm text-uppercase" id="ticker2" placeholder="Ticker 2"></div>
                                    <div class="col-md-2 col-4"><input type="text" class="form-control form-control-sm text-uppercase" id="ticker3" placeholder="Ticker 3"></div>
                                    <div class="col-md-2 col-4"><input type="text" class="form-control form-control-sm text-uppercase" id="ticker4" placeholder="Ticker 4"></div>
                                    <div class="col-md-2 col-4"><input type="text" class="form-control form-control-sm text-uppercase" id="ticker5" placeholder="Ticker 5"></div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-2"><label class="form-label">Tenor (m)</label><select class="form-select form-select-sm" id="tenor"><option value="3">3</option><option value="6">6</option><option value="9">9</option><option value="12">12</option></select></div>
                                    <div class="col-md-2"><label class="form-label">Strike (%)</label><input type="number" class="form-control form-control-sm" id="strike" placeholder="70"></div>
                                    <div class="col-md-2"><label class="form-label">KI Type</label><select class="form-select form-select-sm" id="kiType"><option value="EKI">EKI</option><option value="AKI">AKI</option><option value="N/A">N/A</option></select></div>
                                    <div class="col-md-2"><label class="form-label">KI Barrier (%)</label><input type="number" class="form-control form-control-sm" id="ki" placeholder="65"></div>
                                    <div class="col-md-2"><label class="form-label">KO Type</label><select class="form-select form-select-sm" id="koType"><option value="Daily Memory">Daily Memory</option><option value="Daily Close">Daily Close</option><option value="Monthly">Monthly</option></select></div>
                                    <div class="col-md-2"><label class="form-label">Grtd Periods</label><input type="number" class="form-control form-control-sm" id="guaranteedPeriods" placeholder="2"></div>
                                    <div class="col-12 mt-4"><button type="submit" class="btn btn-primary w-100 fw-bold"><i class="fas fa-paper-plane me-2"></i>é€å‡ºè©¢åƒ¹</button></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="search-pane" role="tabpanel">
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2"><label class="form-label small fw-bold">Quote ID</label><input type="text" class="form-control form-control-sm" id="searchQuoteId" onkeyup="renderCurrentSnapshot()"></div>
                    <div class="col-md-2"><label class="form-label small fw-bold">å®¢æˆ¶å§“å</label><input type="text" class="form-control form-control-sm" id="searchClient" onkeyup="renderCurrentSnapshot()"></div>
                    <div class="col-md-2"><label class="form-label small fw-bold">ç†å°ˆ</label><input type="text" class="form-control form-control-sm" id="searchAdvisor" onkeyup="renderCurrentSnapshot()"></div>
                    <div class="col-md-2"><label class="form-label small fw-bold">å•†å“ä»£ç¢¼</label><input type="text" class="form-control form-control-sm" id="searchTicker" placeholder="ex: TSLA" onkeyup="renderCurrentSnapshot()"></div>
                    <div class="col-md-2"><label class="form-label small fw-bold">å»ºç«‹æ—¥æœŸ</label><input type="date" class="form-control form-control-sm" id="searchDate" onchange="renderCurrentSnapshot()"></div>
                    <div class="col-md-2"><button class="btn btn-sm btn-outline-secondary w-100" onclick="window.resetFilters()">æ¸…é™¤æ¢ä»¶</button></div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                <div class="d-flex align-items-center">
                    <h6 class="text-muted m-0 me-3">æŸ¥è©¢çµæœ <span class="badge bg-white text-dark border ms-1" id="totalCount">0 ç­†</span></h6>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary active" id="btnViewCard" onclick="switchView('card')"><i class="fas fa-th-large me-1"></i>å¡ç‰‡</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnViewList" onclick="switchView('list')"><i class="fas fa-list me-1"></i>æ¸…å–®</button>
                </div>
            </div>

            <div id="ordersListContainer">
                <div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div><p class="small">Loading...</p></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="doubleCheckModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold text-primary"><i class="fas fa-check-double me-2"></i>ç¢ºèªä¸‹å–®å…§å®¹</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted mb-3">è«‹ç¢ºèªä»¥ä¸‹äº¤æ˜“æ¢ä»¶ç„¡èª¤ï¼Œç³»çµ±å°‡è‡ªå‹•ç™¼é€ä¸‹å–®éƒµä»¶çµ¦ä¸Šæ‰‹éŠ€è¡Œã€‚</p>
        <table class="confirm-table w-100">
            <tr><td class="text-muted">Quote ID</td><td class="confirm-val" id="md_quoteId"></td></tr>
            <tr><td class="text-muted">å®¢æˆ¶ (Client)</td><td class="confirm-val" id="md_client"></td></tr>
            <tr><td class="text-muted">é€£çµæ¨™çš„</td><td class="confirm-val" id="md_tickers"></td></tr>
            <tr><td class="text-muted">å±¥ç´„åƒ¹ / KI</td><td class="confirm-val" id="md_strike_ki"></td></tr>
            <tr><td class="text-muted">å¹£åˆ¥</td><td class="confirm-val" id="md_currency"></td></tr>
            <tr class="bg-light"><td class="ps-2 py-3 fw-bold text-dark">ğŸ’° æœ€çµ‚æˆäº¤ç¸½é¢é¡</td><td class="pe-2 py-3 confirm-val highlight-amount" id="md_notional"></td></tr>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-success btn-sm fw-bold" onclick="window.confirmAndSendEmail()">
            <i class="fas fa-paper-plane me-1"></i> ç¢ºèª & ç™¼é€ä¸‹å–®ä¿¡ä»¶
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDWUTTcgGAbyX1_fUy02FWL91689e3gss",
    authDomain: "eln-demo.firebaseapp.com",
    projectId: "eln-demo",
    storageBucket: "eln-demo.firebasestorage.app",
    messagingSenderId: "633561386972",
    appId: "1:633561386972:web:65e6cc903a3a6eacfc0919"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ordersCol = collection(db, "eln_orders_v13"); 

  let currentSnapshot = null;
  let pendingOrderId = null;
  let pendingNotional = null;
  let doubleCheckModal = null;
  
  // â˜…â˜…â˜… View Mode State: 'card' or 'list' â˜…â˜…â˜…
  let currentViewMode = 'card';

  window.formatMoney = (num) => {
      if(!num) return '-';
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // â˜…â˜…â˜… åˆ‡æ›æª¢è¦–æ¨¡å¼ â˜…â˜…â˜…
  window.switchView = (mode) => {
      currentViewMode = mode;
      // UI Button Toggle
      if(mode === 'card') {
          document.getElementById('btnViewCard').classList.add('active');
          document.getElementById('btnViewList').classList.remove('active');
      } else {
          document.getElementById('btnViewCard').classList.remove('active');
          document.getElementById('btnViewList').classList.add('active');
      }
      renderCurrentSnapshot(); // Re-render
  };

  window.fillDemoData = () => {
      document.getElementById('clientName').value = "é™³ç‰è";
      document.getElementById('advisorName').value = "Peggy Pan";
      document.getElementById('productType').value = "FCN";
      document.getElementById('currency').value = "USD";
      document.getElementById('wrapper').value = "EMTN";
      document.getElementById('guaranteedPeriods').value = "2";
      document.getElementById('koType').value = "Daily Memory";
      document.getElementById('kiType').value = "EKI";
      document.getElementById('ticker1').value = "TSLA UW";
      document.getElementById('ticker2').value = "MU UW";
      document.getElementById('ticker3').value = "TSM UN";
      document.getElementById('ticker4').value = "PLTR UW";
      document.getElementById('strike').value = 70;
      document.getElementById('ki').value = 65;
      document.getElementById('tenor').value = "6";
  };

  window.resetFilters = () => {
      document.getElementById('searchQuoteId').value = '';
      document.getElementById('searchClient').value = '';
      document.getElementById('searchAdvisor').value = '';
      document.getElementById('searchTicker').value = '';
      document.getElementById('searchDate').value = '';
      renderCurrentSnapshot();
  }

  document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault(); 
      const dateStr = new Date().toISOString().slice(2,10).replace(/-/g,"");
      const randomCode = Math.floor(1000 + Math.random() * 9000); 
      const autoQuoteId = `Q-${dateStr}-${randomCode}`;

      const payload = {
          quoteId: autoQuoteId,
          clientName: document.getElementById('clientName').value,
          advisorName: document.getElementById('advisorName').value,
          productType: document.getElementById('productType').value,
          currency: document.getElementById('currency').value,
          wrapper: document.getElementById('wrapper').value,
          kiType: document.getElementById('kiType').value,
          koType: document.getElementById('koType').value,
          guaranteedPeriods: document.getElementById('guaranteedPeriods').value,
          tickers: [
            document.getElementById('ticker1').value, document.getElementById('ticker2').value,
            document.getElementById('ticker3').value, document.getElementById('ticker4').value,
            document.getElementById('ticker5').value
          ].filter(t => t.trim() !== ""),
          tenor: document.getElementById('tenor').value,
          strike: document.getElementById('strike').value,
          ki: document.getElementById('ki').value,
          status: "INQUIRY", 
          rejectReason: "",
          quoteResult: null,
          upstreamDocs: null, 
          finalNotional: null,
          createdAt: serverTimestamp() 
      };

      try {
          await addDoc(ordersCol, payload);
          const form = document.getElementById('orderForm');
          form.reset(); 
          form.querySelectorAll('input').forEach(input => input.value = '');
          const successMsg = document.getElementById('successMessage');
          successMsg.style.display = 'block';
          successMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => { successMsg.style.display = 'none'; }, 3500);
      } catch (err) { console.error(err); alert("Error: " + err.message); }
  });

  const q = query(ordersCol, orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
      currentSnapshot = snapshot;
      renderCurrentSnapshot();
  });

  window.renderCurrentSnapshot = () => {
      const currentRole = document.getElementById('roleSwitch').value;
      const container = document.getElementById('ordersListContainer');
      const formContainer = document.getElementById('createFormContainer');
      const warningMsg = document.getElementById('advisorOnlyWarning');
      
      if (currentRole === 'ADVISOR') {
          formContainer.style.display = 'flex';
          warningMsg.style.display = 'none';
      } else {
          formContainer.style.display = 'none';
          warningMsg.style.display = 'block';
      }

      if (!currentSnapshot) return;

      const sQuote = document.getElementById('searchQuoteId').value.toLowerCase();
      const sClient = document.getElementById('searchClient').value.toLowerCase();
      const sAdvisor = document.getElementById('searchAdvisor').value.toLowerCase();
      const sTicker = document.getElementById('searchTicker').value.toLowerCase();
      const sDate = document.getElementById('searchDate').value; 

      // Data Filtering
      let filteredDocs = [];
      currentSnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          
          if (sQuote && !data.quoteId.toLowerCase().includes(sQuote)) return;
          if (sClient && (!data.clientName || !data.clientName.toLowerCase().includes(sClient))) return;
          if (sAdvisor && !data.advisorName.toLowerCase().includes(sAdvisor)) return;
          if (sTicker) {
              const tickersStr = (data.tickers || []).join(" ").toLowerCase();
              if (!tickersStr.includes(sTicker)) return;
          }
          if (sDate && data.createdAt) {
              const dateObj = data.createdAt.toDate();
              const dateStr = dateObj.toISOString().split('T')[0];
              if (dateStr !== sDate) return;
          }
          filteredDocs.push({ id, data });
      });

      document.getElementById('totalCount').innerText = `${filteredDocs.length} ç­†`;

      // Render based on mode
      if (currentViewMode === 'card') {
          renderCardView(container, filteredDocs, currentRole);
      } else {
          renderListView(container, filteredDocs, currentRole);
      }
  };

  // â˜…â˜…â˜… Card View Renderer â˜…â˜…â˜…
  function renderCardView(container, docs, currentRole) {
      let html = '<div class="row g-3">';
      docs.forEach(({id, data}) => {
          const statusConfig = getStatusConfig(data.status);
          const tickerHtml = data.tickers ? data.tickers.map(t => `<span class="ticker-tag">${t}</span>`).join('') : '';
          const actionBtns = getActionButtons(currentRole, data.status, id, data.rejectReason);
          const dateDisplay = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : '';

          let quoteResultHtml = '';
          if (data.status === 'INQUIRY') {
               quoteResultHtml = `<div class="quote-result-box text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>ç­‰å¾…ä¸Šæ‰‹éŠ€è¡Œå ±åƒ¹...</div>`;
          } else if (data.quoteResult) {
               quoteResultHtml = `
                 <div class="quote-result-box active">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                         <span class="badge bg-success">å ±åƒ¹å®Œæˆ</span>
                         <span class="text-muted small">KO: ${data.quoteResult.koBarrier}</span>
                    </div>
                    <div class="text-center mb-2">
                        <div class="text-muted small text-uppercase">Coupon (p.a.)</div>
                        <div class="coupon-rate">${data.quoteResult.coupon}</div>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-2 small text-muted">
                        <span>Memory: <i class="fas fa-check-circle text-success"></i></span>
                        <span>Guarantee: <i class="fas fa-check-circle text-success"></i></span>
                    </div>
                 </div>
               `;
          }

          let notionalHtml = '';
          if (data.status === 'COMPLETED' && data.finalNotional) {
              notionalHtml = `<div class="mt-2 text-center p-2 bg-light border rounded"><span class="text-muted small">æœ€çµ‚ç¸½é¢é¡</span><br><strong class="text-primary">${window.formatMoney(data.finalNotional)} ${data.currency}</strong></div>`;
          }

          html += `
            <div class="col-md-6 col-lg-4">
                <div class="custom-card ${statusConfig.cssClass}">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge ${statusConfig.badgeColor} mb-1">${statusConfig.text}</span>
                                <div class="small text-muted fw-bold">${data.quoteId}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${data.clientName || 'N/A'}</div>
                                <div class="badge bg-light text-dark border">${data.productType || 'FCN'} / ${data.currency}</div>
                            </div>
                        </div>
                        ${getStepperHtml(statusConfig.stepIdx)}
                        <div class="mb-2">${tickerHtml}</div>
                        <table class="table table-sm border-top small mb-1" style="font-size:0.8rem">
                            <tr><td class="text-muted">Wrapper</td><td class="text-end fw-bold">${data.wrapper || '-'}</td></tr>
                            <tr><td class="text-muted">Strike / KI</td><td class="text-end fw-bold text-danger">${data.strike}% / ${data.ki}% (${data.kiType})</td></tr>
                            <tr><td class="text-muted">Tenor / KO</td><td class="text-end">${data.tenor}M / ${data.koType || '-'}</td></tr>
                        </table>
                        ${quoteResultHtml}
                        ${notionalHtml}
                        ${actionBtns ? `<div class="mt-2 pt-2 border-top">${actionBtns}</div>` : ''}
                    </div>
                </div>
            </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
  }

  // â˜…â˜…â˜… List View Renderer â˜…â˜…â˜…
  function renderListView(container, docs, currentRole) {
      if (docs.length === 0) { container.innerHTML = '<div class="text-center py-4">ç„¡è³‡æ–™</div>'; return; }
      
      let html = `
        <div class="table-view-container">
            <div class="table-responsive">
                <table class="table table-hover custom-table mb-0">
                    <thead>
                        <tr>
                            <th width="100">ç‹€æ…‹</th>
                            <th width="140">Quote ID</th>
                            <th>å®¢æˆ¶ / ç”¢å“</th>
                            <th>é€£çµæ¨™çš„</th>
                            <th>Strike/KI</th>
                            <th>Coupon / KO</th>
                            <th>ç¸½é¢é¡</th>
                            <th width="200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>`;
      
      docs.forEach(({id, data}) => {
          const statusConfig = getStatusConfig(data.status);
          const bgClass = statusConfig.badgeColor.replace('badge ', '').replace('text-dark', ''); // Dirty fix for badge classes
          const statusBadge = `<span class="status-badge-sm ${getBgClass(data.status)}">${statusConfig.text}</span>`;
          
          const tickerStr = data.tickers ? data.tickers.join(', ') : '-';
          const couponStr = data.quoteResult ? `<span class="text-success fw-bold">${data.quoteResult.coupon}</span>` : '-';
          const koStr = data.quoteResult ? data.quoteResult.koBarrier : '-';
          const notionalStr = data.finalNotional ? `${window.formatMoney(data.finalNotional)} ${data.currency}` : '-';
          const actionBtns = getActionButtons(currentRole, data.status, id, data.rejectReason);

          html += `
            <tr>
                <td>${statusBadge}</td>
                <td class="font-monospace fw-bold">${data.quoteId}<br><small class="text-muted">${data.createdAt ? data.createdAt.toDate().toLocaleDateString() : ''}</small></td>
                <td>
                    <div class="fw-bold">${data.clientName}</div>
                    <small class="text-muted">${data.productType} / ${data.currency} / ${data.wrapper}</small>
                </td>
                <td><small class="text-primary font-monospace">${tickerStr}</small></td>
                <td>${data.strike}% / ${data.ki}%<br><small class="text-muted">${data.kiType}</small></td>
                <td>${couponStr}<br><small class="text-muted">KO: ${koStr}</small></td>
                <td class="fw-bold">${notionalStr}</td>
                <td>${actionBtns}</td>
            </tr>`;
      });

      html += `</tbody></table></div></div>`;
      container.innerHTML = html;
  }

  function getBgClass(status) {
      switch(status) {
          case 'INQUIRY': return 'bg-inquiry';
          case 'QUOTED': return 'bg-quoted';
          case 'DRAFTING': return 'bg-drafting';
          case 'REVIEW': return 'bg-review';
          case 'SETUP': return 'bg-setup';
          case 'SIGN': return 'bg-sign';
          case 'READY_TO_ORDER': return 'bg-ready';
          case 'COMPLETED': return 'bg-completed';
          default: return 'bg-dark';
      }
  }

  function getStatusConfig(status) {
      switch(status) {
          case "INQUIRY":   return { cssClass: "st-inquiry", text: "è©¢åƒ¹ä¸­", badgeColor: "bg-secondary text-white", stepIdx: 0 };
          case "QUOTED":    return { cssClass: "st-quoted", text: "ä¸Šæ‰‹å ±åƒ¹", badgeColor: "bg-info text-dark", stepIdx: 1 };
          case "DRAFTING":  return { cssClass: "st-drafting", text: "è£½å–®ä¸­", badgeColor: "bg-primary text-white", stepIdx: 2 }; 
          case "REVIEW":    return { cssClass: "st-review", text: "è¦†æ ¸ä¸­", badgeColor: "bg-primary text-white", stepIdx: 3 };
          case "SETUP":     return { cssClass: "st-setup", text: "ä¿¡è¨—å»ºæª”", badgeColor: "bg-warning text-dark", stepIdx: 4 };
          case "SIGN":      return { cssClass: "st-sign", text: "ç­‰å¾…ç°½å", badgeColor: "bg-danger text-white", stepIdx: 5 }; 
          case "READY_TO_ORDER": return { cssClass: "st-ready", text: "å¾…ä¸‹å–®", badgeColor: "bg-danger text-white", stepIdx: 5 }; 
          case "COMPLETED": return { cssClass: "st-completed", text: "äº¤æ˜“å®Œæˆ", badgeColor: "bg-success text-white", stepIdx: 6 };
          case "REJECTED":  return { cssClass: "st-inquiry", text: "è¢«é€€å›", badgeColor: "bg-danger text-white", stepIdx: 0 };
          default:          return { cssClass: "", text: status, badgeColor: "bg-dark text-white", stepIdx: 0 };
      }
  }

  function getStepperHtml(currentIdx) {
      const steps = ['è©¢åƒ¹', 'å ±åƒ¹', 'è£½å–®', 'è¦†æ ¸', 'å»ºæª”', 'ç°½å', 'å®Œæˆ'];
      let html = '<div class="stepper">';
      steps.forEach((step, idx) => {
          let activeClass = idx <= currentIdx ? (idx === currentIdx ? 'active' : 'done') : '';
          html += `<div class="step-item ${activeClass}"><div class="step-dot"></div><div>${step}</div></div>`;
      });
      html += '</div>';
      return html;
  }

  function getActionButtons(role, status, id, rejectReason) {
      if (role === 'ADVISOR') {
          if (status === 'REJECTED') {
               return `<div class="text-danger small mb-1"><i class="fas fa-exclamation-triangle"></i> ${rejectReason}</div><button onclick="window.updateStatus('${id}', 'INQUIRY')" class="btn btn-sm btn-outline-dark w-100">é‡é€</button>`;
          }
          if (status === 'QUOTED') return `<button onclick="window.updateStatus('${id}', 'DRAFTING')" class="btn btn-sm btn-primary w-100">ç¢ºèªå ±åƒ¹</button>`;
          
          if (status === 'SIGN') {
              return `
                <div class="d-flex gap-1">
                <button onclick="window.downloadPackage('${id}')" class="btn btn-sm btn-outline-primary w-50"><i class="fas fa-download"></i></button>
                <button onclick="window.updateStatus('${id}', 'READY_TO_ORDER')" class="btn btn-sm btn-outline-success w-50">å·²ç°½å</button>
                </div>
              `;
          }
          if (status === 'READY_TO_ORDER') return `<span class="text-muted fst-italic small">ç­‰å¾…ä¸‹å–®...</span>`;
      }
      if (role === 'PM') {
          if (status === 'INQUIRY') return `<span class="text-muted small fst-italic">ç­‰å¾…å ±åƒ¹...</span>`; 
          
          if (status === 'DRAFTING') {
              return `<div class="d-flex gap-1"><button onclick="window.rejectOrder('${id}')" class="btn btn-sm btn-outline-danger w-50">é€€ä»¶</button><button onclick="window.contactUpstream('${id}')" class="btn btn-sm btn-primary w-50">ç¢ºèª</button></div>`;
          }
          
          if (status === 'REVIEW') return `<button onclick="window.updateStatus('${id}', 'SETUP')" class="btn btn-sm btn-primary w-100">è¦†æ ¸é€šé</button>`;
          
          if (status === 'SIGN') return `<div class="text-muted small text-center">ç­‰å¾…ç°½å...</div>`; 
          
          if (status === 'READY_TO_ORDER') {
               return `
                 <div class="notional-highlight mb-1 p-1">
                     <input type="text" id="notional_${id}" class="form-control form-control-sm text-end" placeholder="ç¸½é¢é¡">
                 </div>
                 <button onclick="window.prepareCompletion('${id}')" class="btn btn-sm btn-success w-100">ç¢ºèªäº¤æ˜“</button>
               `;
          }
          
          if (status === 'COMPLETED') return `<button class="btn btn-sm btn-light border w-100" disabled>å·²æ­¸æª”</button>`;
      }
      if (role === 'TRUST') {
          if (status === 'SETUP') return `<button onclick="window.updateStatus('${id}', 'SIGN')" class="btn btn-sm btn-warning text-dark w-100">å»ºæª”å®Œæˆ</button>`;
      }
      return "";
  }

  window.updateStatus = async (docId, newStatus) => {
      const docRef = doc(db, "eln_orders_v13", docId);
      let data = { status: newStatus };
      if (newStatus === 'INQUIRY') data.rejectReason = ""; 
      await updateDoc(docRef, data);
  };

  window.simulateIssuerReply = async () => {
      const q = query(ordersCol, where("status", "==", "INQUIRY"));
      const snapshot = await getDocs(q);
      if (snapshot.empty) { alert("ç„¡æ¡ˆä»¶å¯æ¨¡æ“¬ï¼"); return; }
      snapshot.forEach(async (docSnap) => {
          await updateDoc(doc(db, "eln_orders_v13", docSnap.id), { 
              status: "QUOTED",
              quoteResult: { 
                  coupon: (6 + Math.random() * 8).toFixed(2) + "%", 
                  koBarrier: Math.random() > 0.5 ? "103%" : "100%",
                  memory: true, guarantee: true
              }
          });
      });
      alert("å·²æ¨¡æ“¬å ±åƒ¹ï¼");
  };

  window.clearAllData = async () => {
      if(!confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) return;
      const snapshot = await getDocs(query(ordersCol));
      snapshot.forEach(async (docSnap) => { await deleteDoc(doc(db, "eln_orders_v13", docSnap.id)); });
      alert("å·²æ¸…ç©ºï¼");
  };

  window.prepareCompletion = (docId) => {
      const inputEl = document.getElementById('notional_' + docId);
      const amount = inputEl ? inputEl.value : "";
      if (!amount) { alert("è«‹è¼¸å…¥é¢é¡ï¼"); if(inputEl) inputEl.focus(); return; }

      const docData = currentSnapshot.docs.find(d => d.id === docId).data();
      document.getElementById('md_quoteId').innerText = docData.quoteId;
      document.getElementById('md_client').innerText = docData.clientName;
      document.getElementById('md_tickers').innerText = docData.tickers.join(', ');
      document.getElementById('md_strike_ki').innerText = `${docData.strike}% / ${docData.ki}%`;
      document.getElementById('md_currency').innerText = docData.currency;
      document.getElementById('md_notional').innerText = window.formatMoney(amount) + " " + docData.currency;

      pendingOrderId = docId;
      pendingNotional = window.formatMoney(amount);
      doubleCheckModal = new bootstrap.Modal(document.getElementById('doubleCheckModal'));
      doubleCheckModal.show();
  };

  window.confirmAndSendEmail = async () => {
      if(!pendingOrderId) return;
      const docRef = doc(db, "eln_orders_v13", pendingOrderId);
      await updateDoc(docRef, { status: "COMPLETED", finalNotional: pendingNotional });
      if(doubleCheckModal) doubleCheckModal.hide();
      alert(`å·²ç™¼é€ä¸‹å–®ä¿¡ä»¶ï¼\nID: ${pendingOrderId}`);
  };

  window.contactUpstream = async (docId) => {
      const docRef = doc(db, "eln_orders_v13", docId);
      alert("å·²ç™¼ä¿¡ç¢ºèªï¼");
      await updateDoc(docRef, { status: "REVIEW", upstreamDocs: ['TermSheet.pdf', 'KID.pdf'] });
  };

  window.downloadPackage = (docId) => {
      alert("ä¸‹è¼‰ä¸­...");
  };

  window.rejectOrder = async (docId) => {
      const reason = prompt("é€€ä»¶åŸå› ï¼š");
      if (reason) {
          const docRef = doc(db, "eln_orders_v13", docId);
          await updateDoc(docRef, { status: "REJECTED", rejectReason: reason });
      }
  };

  renderCurrentSnapshot();
</script>
</body>
</html>